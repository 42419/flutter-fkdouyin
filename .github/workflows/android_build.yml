name: Android Build & Version Bump

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Calculate Version
        id: version
        run: |
          git fetch --tags
          # 获取最新的 tag，例如 v1.0.4
          LAST_TAG=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "")
          
          # 读取 pubspec.yaml 的版本 (去除 +build)
          YAML_VER=$(grep -E '^version:' pubspec.yaml | head -n1 | awk '{print $2}' | cut -d'+' -f1)
          if [ -z "$YAML_VER" ]; then YAML_VER="1.0.0"; fi
          
          if [ -z "$LAST_TAG" ]; then
            # 无 tag，直接使用 yaml 版本
            NEW_VER="$YAML_VER"
          else
            # 有 tag，比较
            TAG_VER=${LAST_TAG#v}
            
            # 使用 sort -V 比较版本
            # 如果 YAML_VER > TAG_VER，说明用户手动升级了，使用 YAML_VER
            if [ "$(printf '%s\n%s' "$TAG_VER" "$YAML_VER" | sort -V | tail -n1)" = "$YAML_VER" ] && [ "$TAG_VER" != "$YAML_VER" ]; then
               NEW_VER="$YAML_VER"
            else
               # 否则自动递增 patch
               IFS='.' read -r MAJ MIN PAT <<< "$TAG_VER"
               NEW_PAT=$((PAT + 1))
               NEW_VER="${MAJ}.${MIN}.${NEW_PAT}"
            fi
          fi
          
          echo "Calculated version: $NEW_VER"
          echo "version_name=$NEW_VER" >> $GITHUB_OUTPUT

      - name: Build APK
        run: flutter build apk --release --build-name=${{ steps.version.outputs.version_name }} --build-number=${{ github.run_number }}

      - name: Generate changelog
        id: changelog
        run: |
          git fetch --tags || true
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            LOG=$(git log --pretty=format:'- %s')
          else
            LOG=$(git log ${LAST_TAG}..HEAD --pretty=format:'- %s')
          fi
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create git tag
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version_name }}" -m "Release v${{ steps.version.outputs.version_name }}"
          git push origin "v${{ steps.version.outputs.version_name }}"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version_name }}
          name: "Release v${{ steps.version.outputs.version_name }}"
          body: ${{ steps.changelog.outputs.body }}
          files: |
            build/app/outputs/flutter-apk/*-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: build/app/outputs/**
